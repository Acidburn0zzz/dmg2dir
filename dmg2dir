#!/bin/bash

#################################################################################################
#					ENVIRONMENT						#
#################################################################################################
[[ $DEBUG > 1 ]] && set -x

export TEXTDOMAINDIR=@TEXTDOMAINDIR@
export TEXTDOMAIN=dmg2dir
udiskcmd=$(command -v udisksctl)
geniso=$(command -v genisoimage)
darling=$(command -v dyld)
version="3.0.3"
critical=0

name=			# -n
savepath=		# -p
tmpdir="/tmp/dmg2dir"	# -t
run=false		# -r
iso=false		# -i
noappdir=false		# -d
quiet=			# -q
verbose1=		# -v
verbose2=		# -vv
overwriteimg=false	# --overwrite-img
overwritedir=false	# --overwrite-dir
overwriteiso=false	# --overwrite-iso


#################################################################################################
#					COMMONS	FUNCTIONS					#
#################################################################################################
msg() {
	if ! [[ -n "$quiet" ]]; then
		str=$1
		shift
		printf "\033[1;32m==>\033[0;1m `gettext -s "$str"` \033[0m\n" "$@"
	fi
}

msgverbose1() {
	if [[ -n "$verbose1" ]]; then
		str=$1
		shift
		printf "\033[1;34m  ->\033[0m `gettext -s "$str"` \n" "$@"
	fi
}

msgverbose2() {
	if [[ -n "$verbose2" ]]; then
		echo -e "    $1"
	fi
}

error() {
	if [[ -z $err ]]; then
		err=$2
		echo -e "`gettext -s "$1"`"

		if [[ -n "$verbose1" ]]; then
			printf "\033[1;31m `gettext -s 'Error %s has occurred.'` \033[0m\n" "$2"
		fi

		if [[ $critical == 2 ]] ; then
			for part in ${loop}p*; do
				$udiskcmd unmount --no-user-interaction --block-device $part 2>&1 /dev/null
			done
		fi

		if [[ $critical > 0 ]] ; then
			$udiskcmd loop-delete --no-user-interaction --block-device $loop 2>&1 /dev/null
		fi
	fi

	exit $err
}

usage() {
	gettext -es "Usage: dmg2dir [OPTIONS] dmg_file.dmg"
	gettext -es "Options:"
	gettext -es "\t-n, --name\t\tCustom name for application directory which will be created"
	gettext -es "\t-p, --path\t\tCustom path for application directory"
	gettext -es "\t-t, --tmp\t\tCustom temporary directory"
	gettext -es "\t-r, --run\t\tAttempt to run extracted application (use Darling)"
	gettext -es "\t-i, --iso\t\tGenerate an ISO file from IMG file (use Genisoimage)"
	gettext -es "\t-d, --iso-only\t\tSame as --iso, without application directory"
	gettext -es "\t-q, --quiet\t\tBe silent"
	gettext -es "\t-v, --verbose\t\tBe verbose (-vv for very verbose)"
	gettext -es "\t-V, --version\t\tDisplay script version and exit"
	gettext -es "\t-h, --help\t\tDisplay this help and exit"
	gettext -es "\t    --overwrite-img\t\tOverwrite existing IMG file"
	gettext -es "\t    --overwrite-dir\t\tOverwrite existing application directory"
	gettext -es "\t    --overwrite-iso\t\tOverwrite existing ISO file"
	gettext -es "\nPlease report problems at <https://github.com/X0rg/dmg2dir/issues>."
}

version() {
	echo -e "DMG2DIR $version"
	echo -e "Copyleft 2018."
	echo -e "\nWritten by Xorg (https://github.com/X0rg)."
}


#################################################################################################
#					VERIFIES FUNCTIONS					#
#################################################################################################
checkdep() {
	local command="$1"
	local depname="$2"
	local code="$3"

	if [[ -z "$command" ]]; then
		error "Dependency $depname is required." $code
	fi
}

checkfile() {
	if [[ ! -f $1 ]]; then
		error "No output file found." $2
	fi
}

checkvar() {
	if [[ -z $1 ]]; then
		error "Variable is empty." $2
	fi
}

checkdir() {
	if [[ ! -d $1 ]]; then
		error "Directory not fount." $2
	fi

	if [[ $3 == 2 ]]; then
		[[ -z "$(ls -A $1)" ]] && \
		error "Directory is empty." $2
	fi
}

checkcode() {
	if [[ $1 != 0 ]]; then
		error "Command fails." $2
	fi
}


#################################################################################################
#					MAIN FUNCTIONS						#
#################################################################################################
convertdmg() {
	msgverbose1 "Convert %s to %s" "$filetoconvert" "$tmpdir/$name.img"
	dmg2img $quiet $verbose1 $verbose2 -i "$filetoconvert" -o "$tmpdir/$name.img"
	checkfile "$tmpdir/$name.img" 10
}

addloop() {
	msgverbose1 "Set up loop-device"
	loop=$($udiskcmd loop-setup --no-user-interaction --read-only --file "$tmpdir/$name.img")
	checkvar "$loop" 20
	msgverbose2 "$loop"
	critical=1

	msgverbose1 "Retrieve loop device name"
	loop=${loop%.}
	loop=${loop#*/dev/loop}
	checkvar "$loop" 21
	loop="/dev/loop$loop"
	msgverbose2 "$loop"
}

mountpart() {
	local part=$1

	mountpoint=$(findmnt --noheadings --output TARGET $part)
	if [[ -z "$mountpoint" ]]; then
		msgverbose1 "Mount loop-device partition %s" "$part"
		$udiskcmd mount --block-device $part > $output
		mountpoint=$(findmnt --noheadings --output TARGET $part)
	fi
	checkvar "$mountpoint" 30
	msgverbose2 "$mountpoint"
	critical=2

	if $iso; then
		local label=$(basename "$mountpoint")
		ln -sf $verbose1 "$mountpoint" "$tmpdir/$name/$label"
	fi
}

copydir() {
	msgverbose1 "Copy files in application directory"
	cp -Raup $verbose1 "$mountpoint" "$appdir"
	checkdir "$appdir" 40 2
}

convertiso() {
	$geniso $verbose1 -V "$name" -iso-level 3 -UDF -R -probe -g -posix-L -o "$appdir.iso" "$vtree"
	checkfile "$appdir.iso" 50
}

umountpart() {
	local part=$1

	msgverbose1 "Unmount loop-device partition %s" "$part"
	$udiskcmd unmount --no-user-interaction --force --block-device $part > $output
	checkcode "$?" 60
	msgverbose2 "Device unmounted"
	critical=1
}

delloop() {
	if [[ -f $loop* ]]; then
		msgverbose1 "Delete loop-device"
		$udiskcmd loop-delete --no-user-interaction --block-device $loop
		checkcode "$?" 70
		msgverbose2 "Device deleted"
	fi
	critical=0
}

launcher() {
	find "$appdir"/*/*.app/Contents/MacOS -exec file '{}' \; | grep "Mach-O" | grep "executable" | cut -f1 -d: | while IFS= read -r executable; do
		msgverbose1 "Found file %s, launch it with dyld" "$executable"
		dyld "$executable"
	done
}


#################################################################################################
#					MAIN							#
#################################################################################################
# Args
OPTS=`getopt -o n:p:t:ridqvwVh --long name:,path:,tmp:,run,iso,iso-only,quiet,verbose,version,help,overwrite-img,overwrite-dir,overwrite-iso -n 'dmg2dir' -- "$@"`
if [[ $? != 0 ]]; then
	error "Failed parsing options." 1
fi

eval set -- "$OPTS"
while true ; do
	case "$1" in
		-n|--name)		shift; name="$1";;
		-p|--path)		shift; savepath="$1";;
		-t|--tmp)		shift; tmpdir="$1";;
		-r|--run)		checkdep "$darling" "Darling" 1; run=true;;
		-i|--iso)		checkdep "$geniso" "cdrtools/cdrkit" 1; iso=true;;
		-d|--iso-only)		checkdep "$geniso" "cdrtools/cdrkit" 1; iso=true; noappdir=true;;
		-q|--quiet)		quiet="-s";;
		-v|--verbose)		unset quiet; [[ -z $verbose1 ]] && verbose1="-v" || verbose2="-V";;
		-V|--version)		version; exit 0;;
		-h|--help)		usage; exit 0;;
		--overwrite-img)	overwriteimg=true;;
		--overwrite-dir)	overwritedir=true;;
		--overwrite-iso)	overwriteiso=true;;
		--)			shift; break;;
		*)			 echo "Internal error!"; exit 1;;
	esac
	shift
done

# Prerequisites
msg "Check prerequisites..."
filetoconvert="$1"
if [[ -z "$filetoconvert" ]]; then
	usage
	exit 1
fi
if [[ ! -f "$filetoconvert" ]]; then
	error "File doesn't exist." 1
fi
checkdep "$udiskcmd" "udisks2" 1
#if ! $(groups | grep -q disk); then
#	error "You need to be in group 'disk'."
#fi

[[ -z "$name" ]] && name=$(basename "$filetoconvert" .dmg)
[[ -z "$savepath" ]] && savepath=$(dirname "$filetoconvert")
[[ -z "$verbose2" ]] && output="/dev/null" || output="/dev/stdout"
appdir="$savepath/$name"
vtree="$tmpdir/$name"

if ! $noappdir && ! $overwritedir && [[ -e "$appdir" ]]; then
	error "Directory $appdir already exists. Use --overwrite-dir to overwrite it." 1
fi
if $iso && ! $overwriteiso && [[ -e "$appdir.iso" ]]; then
	error "File $appdir.iso already exists. Use --overwrite-iso to overwrite it." 1
fi

# Start
if [[ ! -d "$tmpdir" ]] || [[ ! -d "$tmpdir/$name" ]] ; then
	msg "Make temporary working directory..."
	mkdir -p $verbose1 "$tmpdir"
fi
$iso && mkdir -p $verbose1 "$vtree"

msg "Convert DMG file to IMG file..."
if [[ ! -f "$tmpdir/$name.img" ]] || $overwriteimg; then
	convertdmg
else
	msgverbose1 "File %s already exists. Skipping conversion. Use --overwrite-img to overwrite it." "$tmpdir/$name.img"
fi

msg "Prepare loop device..."
addloop

if ! $noappdir; then
	msgverbose1 "Make application directory: %s" "$appdir"
	mkdir -p $verbose1 "$appdir"
fi

for part in ${loop}p*; do
	mountpart $part
	if ! $noappdir; then
		copydir
	fi
done

if $iso; then
	msg "Generate ISO file..."
	convertiso
	rm -rf $verbose1 "$vtree"
fi

for part in ${loop}p*; do
	umountpart $part
done

delloop

if $run && ! $noappdir; then
	msg "Try to run binary file with Darling..."
	launcher
fi

exit 0

# Written by Xorg (https://github.com/X0rg/dmg2dir). Copyleft 2018.
