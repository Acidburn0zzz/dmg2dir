#!/bin/bash

#################################################################################################
#					ENVIRONMENT						#
#################################################################################################
[[ $DEBUG > 1 ]] && set -x

export TEXTDOMAINDIR=@TEXTDOMAINDIR@
export TEXTDOMAIN=dmg2dir
udiskcmd=$(command -v udisksctl)
geniso=$(command -v genisoimage)
darling=$(command -v dyld)
version="3.0.3"
critical=0

name=			# -n
savepath=		# -p
tmpdir="/tmp/dmg2dir"	# -t
force=false		# -f
run=false		# -r
iso=false		# -i
nodir=false		# -d
quiet=			# -q
v=			# -v
w=			# -w


#################################################################################################
#					COMMONS	FUNCTIONS					#
#################################################################################################
msg() {
	if ! [[ -n "$quiet" ]]; then
		str=$1
		shift
		printf "\033[1;32m==>\033[0;1m `gettext -s "$str"` \033[0m\n" "$@"
	fi
}

msgv() {
	if [[ -n "$v" ]]; then
		str=$1
		shift
		printf "\033[1;34m  ->\033[0m `gettext -s "$str"` \n" "$@"
	fi
}

msgw() {
	if [[ -n "$w" ]]; then
		echo -e "    $1"
	fi
}

error() {
	if [[ -z $err ]]; then
		err=$2
		echo -e "`gettext -s "$1"`"

		if [[ -n "$v" ]]; then
			printf "\033[1;31m `gettext -s 'Error %s has occurred.'` \033[0m\n" "$2"
		fi

		if [[ $critical == 2 ]] ; then
			for part in ${loop}p*; do
				$udiskcmd unmount --no-user-interaction --block-device $part 2>&1 /dev/null
			done
		fi

		if [[ $critical > 0 ]] ; then
			$udiskcmd loop-delete --no-user-interaction --block-device $loop 2>&1 /dev/null
		fi
	fi

	exit $err
}

usage() {
	gettext -es "Usage: dmg2dir [OPTIONS] dmg_file.dmg"
	gettext -es "Options:"
	gettext -es "\t-n, --name\t\tCustom name for application directory which will be created"
	gettext -es "\t-p, --path\t\tCustom path for application directory"
	gettext -es "\t-t, --tmp\t\tCustom temporary directory"
	gettext -es "\t-f, --force\t\tOverwrite existing IMG file"
	gettext -es "\t-r, --run\t\tAttempt to run extracted application (use Darling)"
	gettext -es "\t-i, --iso\t\tGenerate an ISO file from IMG file (use Genisoimage)"
	gettext -es "\t-d, --iso-only\t\tSame as --iso, without application directory"
	gettext -es "\t-q, --quiet\t\tRun silently"
	gettext -es "\t-v, --verbose\t\tRun verbosely"
	gettext -es "\t-w, --+verbose\t\tRun more verbosely"
	gettext -es "\t-V, --version\t\tDisplay script version and exit"
	gettext -es "\t-h, --help\t\tDisplay this help and exit"
	gettext -es "\nPlease report problems at <https://github.com/X0rg/dmg2dir/issues>."
}

version() {
	echo -e "DMG2DIR $version"
	echo -e "Copyleft 2018."
	echo -e "\nWritten by Xorg (https://github.com/X0rg)."
}


#################################################################################################
#					VERIFIES FUNCTIONS					#
#################################################################################################
checkfile() {
	if [[ ! -f $1 ]]; then
		error "No output file found." $2
	fi
}

checkvar() {
	if [[ -z $1 ]]; then
		error "Variable is empty." $2
	fi
}

checkdir() {
	if [[ ! -d $1 ]]; then
		error "Directory not fount." $2
	fi

	if [[ $3 == 2 ]]; then
		[[ -z "$(ls -A $1)" ]] && \
		error "Directory is empty." $2
	fi
}

checkcode() {
	if [[ $1 != 0 ]]; then
		error "Command fails." $2
	fi
}


#################################################################################################
#					MAIN FUNCTIONS						#
#################################################################################################
convertdmg() {
	msgv "Convert %s to %s" "$filetoconvert" "$tmpdir/$name.img"
	dmg2img $quiet $v $w -i "$filetoconvert" -o "$tmpdir/$name.img"
	checkfile "$tmpdir/$name.img" 10
}

addloop() {
	msgv "Set up loop-device"
	loop=$($udiskcmd loop-setup --no-user-interaction --read-only --file "$tmpdir/$name.img")
	checkvar "$loop" 20
	msgw "$loop"
	critical=1

	msgv "Retrieve loop device name"
	loop=${loop%.}
	loop=${loop#*/dev/loop}
	checkvar "$loop" 21
	loop="/dev/loop$loop"
	msgw "$loop"

	msgv "Set application directory"
	app_directory="$savepath/$name"
	checkvar "$app_directory" 22
	msgw "$app_directory"
}

mountpart() {
	local part=$1

	msgv "Mount loop-device partition %s" "$part"
	$udiskcmd mount --block-device $part > $output
	mountpoint=$(findmnt --noheadings --output TARGET $part)
	checkvar "$mountpoint" 30
	msgw "$mountpoint"
	critical=2

	if $iso; then
		local label=$(basename "$mountpoint")
		ln -sf $v "$mountpoint" "$tmpdir/$name/$label"
	fi
}

copydir() {
	msgv "Copy files in application directory"
	cp -Raup $v "$mountpoint" "$app_directory"
	checkdir "$app_directory" 40 2
}

convertiso() {
	$geniso $v -V "$name" -iso-level 3 -UDF -R -probe -g -posix-L -o "$app_directory.iso" "$vtree"
	checkfile "$app_directory.iso" 50
}

umountpart() {
	local part=$1

	msgv "Unmount loop-device partition %s" "$part"
	$udiskcmd unmount --no-user-interaction --block-device $part > $output
	checkcode "$?" 60
	msgw "Device unmounted"
	critical=1
}

delloop() {
	msgv "Delete loop-device"
	$udiskcmd loop-delete --no-user-interaction --block-device $loop
	checkcode "$?" 70
	msgw "Device deleted"
	critical=0
}

launcher() {
	find "$app_directory"/*/*.app/Contents/MacOS -exec file '{}' \; | grep "Mach-O" | grep "executable" | cut -f1 -d: | while IFS= read -r executable; do
		msgv "Found file %s, launch it with dyld" "$executable"
		dyld "$executable"
	done
}


#################################################################################################
#					MAIN							#
#################################################################################################
# Args
OPTS=`getopt -o n:p:t:fridqvwVh --long name:,path:,tmp:,force,run,iso,iso-only,quiet,verbose,version,help -n 'dmg2dir' -- "$@"`
if [[ $? != 0 ]]; then
	error "Failed parsing options." 1
fi

eval set -- "$OPTS"
while true ; do
	case "$1" in
		-n|--name)	shift; name="$1";;
		-p|--path)	shift; savepath="$1";;
		-t|--tmp)	shift; tmpdir="$1";;
		-f|--force)	force=true;;
		-r|--run)	run=true;;
		-i|--iso)	iso=true;;
		-d|--iso-only)	iso=true; nodir=true;;
		-q|--quiet)	quiet="-s";;
		-v|--verbose)	unset quiet; v="-v";;
		-w|--+verbose)	unset quiet; v="-v"; w=-V;;
		-V|--version)	version; exit 0;;
		-h|--help)	usage; exit 0;;
		--)		shift; break;;
		*) echo "Internal error!"; exit 1;;
	esac
	shift
done

# Routines
filetoconvert=$1
if [[ -z $filetoconvert ]]; then
	usage
	exit 1
fi
if [[ ! -f "$filetoconvert" ]]; then
	error "File doesn't exist." 1
fi
if [[ -z $udiskcmd ]] || ($run && [[ -z $darling ]]) || ($iso && [[ -z $geniso ]]); then
	error "Missing package." 1
fi
#if ! $(groups | grep -q disk); then
#	error "You need to be in group 'disk'."
#fi

[[ -z "$name" ]] && name=$(basename "$filetoconvert" .dmg)
[[ -z "$savepath" ]] && savepath=$(dirname "$filetoconvert")
[[ -z $w      ]] && output="/dev/null" || output="/dev/stdout"
vtree="$tmpdir/$name"
msg "Routines successfully accomplished. Ready!"

# Start
if [[ ! -d "$tmpdir" ]] || [[ ! -d "$tmpdir/$name" ]] ; then
	msg "Make temporary working directory..."
	mkdir -p $v "$tmpdir"
fi
$iso && mkdir -p $v "$vtree"

if [[ ! -f "$tmpdir/$name.img" ]] || $force; then
	msg "Convert DMG file to IMG file..."
	convertdmg
else
	msgv "File %s exists. Use --force to override it." "$tmpdir/$name.img"
fi

msg "Prepare loop device..."
addloop

if ! $nodir; then
	msgv "Make application directory: %s" "$app_directory"
	mkdir -p $v "$app_directory"
fi

for part in ${loop}p*; do
	mountpart $part
	if ! $nodir; then
		copydir
	fi
done

if $iso; then
	msg "Generate ISO file..."
	convertiso
	rm -rf $v "$vtree"
fi

for part in ${loop}p*; do
	umountpart $part
done

delloop

if $run && ! $nodir; then
	msg "Try to run binary file with Darling..."
	launcher
fi

exit 0

# Written by Xorg (https://github.com/X0rg/dmg2dir). Copyleft 2018.
